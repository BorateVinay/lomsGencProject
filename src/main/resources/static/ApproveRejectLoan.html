 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Loan Applications</title>
    <!-- Load Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        /* Custom styles for better aesthetics */
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            --bs-table-bg-type: rgba(0,0,0,.03);
        }
        .container {
            padding-top: 30px;
            padding-bottom: 30px;
        }
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 250px;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="mb-4 text-center text-primary">Loan Review Dashboard</h1>

        <!-- Status Message Box (Replaces alert()) -->
        <div id="statusMessage" class="status-message alert" role="alert">
            <!-- Message content will be inserted here -->
        </div>

        <div class="card p-4">
            <h2 class="card-title mb-3">Pending Applications</h2>
            
            <div id="loadingIndicator" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Fetching loan data...</p>
            </div>

            <div class="table-responsive" id="loanTableContainer" style="display: none;">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Customer Name</th>
                            <th scope="col">Loan Type</th>
                            <th scope="col">Amount</th>
                            <th scope="col">Email</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody id="loanApplicationsBody">
                        <!-- Loan rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Message for when no loans are pending -->
            <div id="noLoansMessage" class="alert alert-info text-center mt-4" style="display: none;">
                <p class="lead mb-0">No pending loan applications found.</p>
            </div>

            <!-- Error Message Area -->
             <div id="errorMessage" class="alert alert-danger text-center mt-4" style="display: none;">
                <p class="lead mb-0">Could not load loan applications.</p>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap 5 JS CDN (Optional, but good practice for components like dropdowns/modals) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        // API Endpoints based on user's controller definitions
        const LOAN_API_URL = 'http://localhost:8082/getPendingLoanApplication';
        const APPROVE_API_BASE = 'http://localhost:8082/approveLoan'; 
        const REJECT_API_BASE = 'http://localhost:8082/reject'; 

        const loanApplicationsBody = document.getElementById('loanApplicationsBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loanTableContainer = document.getElementById('loanTableContainer');
        const noLoansMessage = document.getElementById('noLoansMessage');
        const errorMessage = document.getElementById('errorMessage');
        const statusMessageDiv = document.getElementById('statusMessage');

        /**
         * Utility function to display a temporary status message (replaces alert()).
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'danger' for styling.
         */
        function showStatusMessage(message, type) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `status-message alert alert-${type}`;
            statusMessageDiv.style.display = 'block';

            setTimeout(() => {
                statusMessageDiv.style.display = 'none';
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Handles the Approve or Reject action for a specific loan.
         * @param {number} applicationId - The ID of the loan application.
         * @param {string} action - 'APPROVED' or 'REJECTED'.
         */
        async function handleAction(applicationId, action) {
            // FIX: Explicitly call window.confirm() to prevent recursion error
            if (!window.confirm(`Are you sure you want to ${action === 'APPROVED' ? 'APPROVE' : 'REJECT'} loan ${applicationId}?`)) {
                return;
            }

            let url = '';
            let actionText = '';

            if (action === 'APPROVED') {
                url = `${APPROVE_API_BASE}/${applicationId}`;
                actionText = 'APPROVED';
            } else if (action === 'REJECTED') {
                url = `${REJECT_API_BASE}/${applicationId}`;
                actionText = 'REJECTED';
            } else {
                console.error('Invalid action:', action);
                return;
            }

            try {
                // Use PUT method as specified by the user's controller
                const response = await fetch(url, {
                    method: 'PUT', 
                    // No headers or body needed as ID is passed in the URL path
                });

                if (response.ok) {
                    showStatusMessage(`Loan ${applicationId} successfully ${actionText}.`, 'success');
                    // Remove the row from the table on success
                    const rowToRemove = document.getElementById(`loan-row-${applicationId}`);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                    // Re-check if the table is empty
                    if (loanApplicationsBody.children.length === 0) {
                        loanTableContainer.style.display = 'none';
                        noLoansMessage.style.display = 'block';
                    }
                } else {
                    // This handles non-2xx responses
                    showStatusMessage(`Failed to ${actionText.toLowerCase()} loan ${applicationId}. Server responded with status ${response.status}.`, 'danger');
                }
            } catch (error) {
                console.error('Error updating loan status:', error);
                showStatusMessage(`An error occurred while communicating with the server to ${actionText.toLowerCase()} the loan.`, 'danger');
            }
        }

        /**
         * Renders the fetched loan data into the HTML table.
         * @param {Array<Object>} applications - The list of loan application objects.
         */
        function renderLoans(applications) {
            loanApplicationsBody.innerHTML = ''; // Clear existing content

            if (!applications || applications.length === 0) {
                noLoansMessage.style.display = 'block';
                loanTableContainer.style.display = 'none';
                return;
            }

            applications.forEach(app => {
                const row = document.createElement('tr');
                row.id = `loan-row-${app.applicationId}`;
                
                // Format amount Requested as currency (assuming USD/Generic Currency for display)
                const formattedAmount = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0
                }).format(app.amountRequested);

                row.innerHTML = `
                    <th scope="row">${app.applicationId}</th>
                    <td>${app.customer.name}</td>
                    <td><span class="badge text-bg-secondary">${app.loanType}</span></td>
                    <td><strong class="text-success">${formattedAmount}</strong></td>
                    <td><a href="mailto:${app.customer.email}">${app.customer.email}</a></td>
                    <td>
                        <button class="btn btn-sm btn-success me-2 approve-btn" data-id="${app.applicationId}">Approve</button>
                        <button class="btn btn-sm btn-danger reject-btn" data-id="${app.applicationId}">Reject</button>
                    </td>
                `;
                loanApplicationsBody.append(row);
            });

            // Attach event listeners to the buttons using event delegation
            loanApplicationsBody.querySelectorAll('.approve-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    handleAction(id, 'APPROVED');
                });
            });

            loanApplicationsBody.querySelectorAll('.reject-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    handleAction(id, 'REJECTED');
                });
            });

            loanTableContainer.style.display = 'block';
        }


        /**
         * Fetches loan applications from the API.
         */
        async function fetchLoans() {
            loadingIndicator.style.display = 'block';
            loanTableContainer.style.display = 'none';
            noLoansMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                const response = await fetch(LOAN_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Assuming the actual loan list is under the 'Message' key
                const applications = data.Message;

                renderLoans(applications);

            } catch (error) {
                console.error('Fetch error:', error);
                errorMessage.style.display = 'block';
                showStatusMessage('Error fetching data. Check console for details.', 'danger');
                
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // Start the process when the page loads
        document.addEventListener('DOMContentLoaded', fetchLoans);

        // NOTE: The redundant 'confirm' function wrapper has been removed to fix the recursion error.

    </script>
</body>
</html>
 