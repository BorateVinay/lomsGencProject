<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Evaluation - LOMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* Define a custom color palette */
        :root {
            --bs-primary: #007bff;
            --bs-success: #28a745;
            --bs-warning: #ffc107;
            --bs-danger: #dc3545;
            --color-indigo-500: #6610f2;
        }

        /* Set font and background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; 
        }

        /* Score meter styling (kept the same for function) */
        .score-meter {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(
                var(--score-color) var(--score-percent), 
                #e5e7eb var(--score-percent)
            );
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .score-meter::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: white;
        }

        .score-text {
            position: relative;
            z-index: 10;
            font-size: 2.5rem;
            font-weight: 700;
        }
        /* Hide class for the spinner is removed from here and HTML */
    </style>
</head>
<body class="min-vh-100">

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid container-xl">
            <a class="navbar-brand fs-4 fw-bold text-primary" href="#">LOMS Credit Portal</a>
            <div class="d-flex align-items-center">
                <span id="customer-info" class="text-secondary small"></span>
            </div> 
        </div>
    </nav>

    <div class="container container-xl my-4 my-sm-5">
        <div class="bg-white p-4 p-md-5 rounded-3 shadow">
            <h1 class="fs-2 fw-bolder text-dark mb-4 d-flex align-items-center">
                <i class="bi bi-bar-chart-fill text-primary me-3 fs-3"></i>
                Credit Evaluation Report
            </h1>

            <button id="evaluateButton" onclick="evaluateCreditScore()"
                class="btn btn-primary btn-lg px-4 py-2 mb-4 shadow-sm" style="min-width: 250px;">
                <span id="buttonText">Evaluate New Credit Score</span>
                </button>

            <div id="messageArea" class="mb-4"></div>
            
            <div id="reportContainer" class="d-none">
                <div class="d-flex flex-column flex-md-row align-items-center justify-content-between p-4 bg-light rounded-3 border mb-4">
                    <div class="text-center text-md-start mb-4 mb-md-0">
                        <p class="text-muted text-uppercase fw-medium mb-1 small">Your Latest Score</p>
                        <h2 id="displayScore" class="fs-1 fw-bolder text-dark mt-1">N/A</h2>
                        <span id="scoreRating" class="badge rounded-pill mt-2"></span>
                    </div>

                    <div class="score-meter" id="scoreMeter" style="--score-percent: 0%; --score-color: #6c757d;">
                        <span class="score-text text-dark"></span>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-12">
                         <div class="card p-3 border-0 shadow-sm">
                            <div class="card-body p-0 d-flex align-items-center">
                                <i class="bi bi-calendar text-info me-3 fs-4" style="color: var(--color-indigo-500) !important;"></i>
                                <div>
                                    <p class="text-muted mb-0 small">Last Evaluated On</p>
                                    <p id="displayDate" class="fw-bold text-dark mb-0">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-primary-subtle border-start border-5 border-primary rounded-3">
                    <h3 class="fw-semibold fs-5 text-primary mb-2 d-flex align-items-center">
                        <i class="bi bi-lightbulb-fill me-2"></i> Credit Guidance
                    </h3>
                    <p id="guidanceText" class="text-primary-emphasis small mb-0">
                        This score is based on your relationship history with LOMS. To improve your score, maintain a low number of outstanding loans and ensure timely repayments.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
    // Simplified JavaScript with no loading animation, using only basic DOM manipulation and fetch.

    const reportContainer = document.getElementById('reportContainer');
    const messageArea = document.getElementById('messageArea');
    const evaluateBtn = document.getElementById('evaluateButton');
    const buttonText = document.getElementById('buttonText');

    // Function to determine color and rating based on the LOMS score scale
    function getScoreMetrics(score) {
        let rating = '';
        let color = ''; // For the meter background color
        let colorClass = ''; // For the badge class

        if (score >= 350) {
            rating = 'Excellent';
            color = 'var(--bs-primary)';
            colorClass = 'bg-primary text-white';
        } else if (score >= 330) {
            rating = 'Very Good';
            color = 'var(--bs-success)';
            colorClass = 'bg-success text-white';
        } else if (score >= 310) {
            rating = 'Good';
            color = 'var(--bs-warning)';
            colorClass = 'bg-warning text-dark';
        } else {
            rating = 'Poor';
            color = 'var(--bs-danger)';
            colorClass = 'bg-danger text-white';
        }
        return { rating, color, colorClass };
    }

    // Simplified UI update function: just disable/enable the button and change text
    function setLoading(isLoading) {
        evaluateBtn.disabled = isLoading;
        if (isLoading) {
            buttonText.textContent = 'Evaluating...';
            messageArea.innerHTML = '';
        } else {
            buttonText.textContent = 'Evaluate New Credit Score';
        }
    }

    // Function to display alerts
    function displayMessage(type, message) {
        let iconClass = '';
        let baseClass = 'alert d-flex align-items-center mb-0';
        
        if (type === 'success') {
            iconClass = 'bi bi-check-circle-fill me-2';
            baseClass += ' alert-success border-success-subtle';
        } else if (type === 'error') {
            iconClass = 'bi bi-exclamation-triangle-fill me-2';
            baseClass += ' alert-danger border-danger-subtle';
        } else if (type === 'info') {
            iconClass = 'bi bi-info-circle-fill me-2';
            baseClass += ' alert-info border-info-subtle';
        }
        
        messageArea.innerHTML = `<div class="${baseClass}" role="alert"><i class="${iconClass}"></i> ${message}</div>`;
    }

    // Function to render the credit report from the API data
    function renderReport(data) {
        const score = data.creditScore;
        const metrics = getScoreMetrics(score);
        const evaluationDate = data.evaluationDate;
        
        const scoreMeterElement = document.getElementById('scoreMeter');
        const scoreTextElement = scoreMeterElement.querySelector('.score-text');

        // Calculate percentage for gauge 
        const SCORE_MIN = 300;
        const SCORE_MAX = 850;
        const scorePercent = Math.min(100, Math.max(0, (score - SCORE_MIN) / (SCORE_MAX - SCORE_MIN) * 100));

        // Apply styles to score meter
        scoreMeterElement.style.setProperty('--score-percent', `${scorePercent}%`);
        scoreMeterElement.style.setProperty('--score-color', metrics.color);
        scoreTextElement.textContent = score;
        scoreTextElement.style.color = metrics.color;

        // Update detailed display elements
        document.getElementById('displayScore').textContent = score;
        document.getElementById('displayScore').style.color = metrics.color;
        
        document.getElementById('scoreRating').textContent = metrics.rating;
        document.getElementById('scoreRating').className = metrics.colorClass + ' badge rounded-pill mt-2'; 
        
        document.getElementById('displayDate').textContent = evaluationDate;
        
        document.getElementById('customer-info').textContent = localStorage.getItem('customerName');
        
        reportContainer.classList.remove('d-none');
    }

    // Core function to call the API with basic async/await fetch
    async function evaluateCreditScore() {
        setLoading(true);
        reportContainer.classList.add('d-none'); // Hide old report

        const url = `http://localhost:8082/evaluate`; 
        
        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            // Handle non-200 responses
            if (!response.ok) {
                let statusText = `HTTP Error ${response.status}`;
                try {
                    const errorResult = await response.json();
                    if (errorResult.message) statusText = errorResult.message;
                } catch (e) {
                    // Ignore JSON parsing errors if response is non-JSON
                }
                throw new Error(statusText);
            }

            const result = await response.json();
            
            if (result.status === 'Success') {
                displayMessage('success', result.message);
                renderReport(result.data);
            } else {
                const errorMessage = result.message || 'An unknown error occurred during evaluation.';
                displayMessage('error', errorMessage);
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            // Display a user-friendly error message
            displayMessage('error', `Evaluation failed. Please ensure the API server is running at ${url}. Error: ${error.message}`);
        } finally {
            setLoading(false);
        }
    }

    // Initial setup on load
    window.onload = () => {
        // Set mock customer name on load if not present for navbar
        if (!localStorage.getItem('customerName')) {
             localStorage.setItem('customerName', 'Jane Doe');
        }
        document.getElementById('customer-info').textContent = localStorage.getItem('customerName');

        displayMessage('info', 'Press the button to evaluate your latest Credit Score.');
    };
    </script>
</body>
</html>