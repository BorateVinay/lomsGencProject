<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Evaluation - LOMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Define a custom color palette */
        :root {
            --color-primary: #007bff; /* Primary Blue */
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
        }

        /* Set font to Inter (Tailwind default) and background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* Score meter styling */
        .score-meter {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(
                var(--score-color) var(--score-percent), 
                #e5e7eb var(--score-percent)
            );
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .score-meter::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: white;
        }

        .score-text {
            position: relative;
            z-index: 10;
            font-size: 2.5rem;
            font-weight: 700;
        }
    </style>
</head>
<body class="min-h-screen">

    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a class="text-xl font-bold text-blue-600" href="#">LOMS Credit Portal</a>
                <div class="flex items-center space-x-4">
                    <span id="customer-info" class="text-gray-600 text-sm"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 flex items-center">
                <i data-lucide="bar-chart-3" class="w-8 h-8 text-blue-600 mr-3"></i>
                Credit Evaluation Report
            </h1>

            <button id="evaluateButton" onclick="evaluateCreditScore()"
                class="w-full md:w-auto px-6 py-3 mb-8 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50">
                <span id="buttonText">Evaluate New Credit Score</span>
                <i id="loadingSpinner" class="hidden w-5 h-5 ml-2 animate-spin" data-lucide="loader-2"></i>
            </button>

            <div id="messageArea" class="mb-6"></div>
            
            <div id="reportContainer" class="hidden">
                <div class="flex flex-col md:flex-row items-center justify-between p-6 bg-gray-50 rounded-lg border border-gray-200 mb-8">
                    <div class="text-center md:text-left mb-4 md:mb-0">
                        <p class="text-sm font-medium text-gray-500 uppercase">Your Latest Score</p>
                        <h2 id="displayScore" class="text-5xl font-extrabold text-gray-900 mt-1">N/A</h2>
                        <span id="scoreRating" class="inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full"></span>
                    </div>

                    <div class="score-meter" id="scoreMeter" style="--score-percent: 0%; --score-color: #6b7280;">
                        <span class="score-text text-gray-900"></span>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="p-5 bg-white border border-gray-200 rounded-lg shadow-sm md:col-span-2"> <div class="flex items-center">
                            <i data-lucide="calendar" class="w-6 h-6 text-indigo-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-500">Last Evaluated On</p>
                                <p id="displayDate" class="font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-6 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                    <h3 class="font-semibold text-lg text-blue-800 mb-2 flex items-center">
                        <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i> Credit Guidance
                    </h3>
                    <p id="guidanceText" class="text-blue-700 text-sm">
                        This score is based on your relationship history with LOMS. To improve your score, maintain a low number of outstanding loans and ensure timely repayments.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // NOTE: This customerId is MOCKED since true session management is done server-side.
     

    const reportContainer = document.getElementById('reportContainer');
    const messageArea = document.getElementById('messageArea');
    const evaluateBtn = document.getElementById('evaluateButton');
    const buttonText = document.getElementById('buttonText');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Function to determine color and rating based on the LOMS score scale
    function getScoreMetrics(score) {
        let rating = '';
        let color = '';
        let colorClass = '';

        // Score ranges used for visual rating (300-400 logic retained from original)
        if (score >= 350) {
            rating = 'Excellent';
            color = '#007bff'; /* Blue (Primary) */
            colorClass = 'bg-blue-100 text-blue-700';
        } else if (score >= 330) {
            rating = 'Very Good';
            color = '#28a745'; /* Green (Success) */
            colorClass = 'bg-green-100 text-green-700';
        } else if (score >= 310) {
            rating = 'Good';
            color = '#ffc107'; /* Yellow (Warning) */
            colorClass = 'bg-yellow-100 text-yellow-700';
        } else {
            rating = 'Poor';
            color = '#dc3545'; /* Red (Danger) */
            colorClass = 'bg-red-100 text-red-700';
        }
        return { rating, color, colorClass };
    }

    function setLoading(isLoading) {
        evaluateBtn.disabled = isLoading;
        if (isLoading) {
            buttonText.textContent = 'Evaluating...';
            loadingSpinner.classList.remove('hidden');
            messageArea.innerHTML = '';
        } else {
            buttonText.textContent = 'Evaluate New Credit Score';
            loadingSpinner.classList.add('hidden');
        }
    }

    function displayMessage(type, message) {
        let icon = '';
        let baseClass = 'p-4 rounded-lg text-sm font-medium flex items-center';
        if (type === 'success') {
            icon = '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>';
            baseClass += ' bg-green-100 text-green-800 border border-green-200';
        } else if (type === 'error') {
            icon = '<i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>';
            baseClass += ' bg-red-100 text-red-800 border border-red-200';
        } else if (type === 'info') {
            icon = '<i data-lucide="info" class="w-5 h-5 mr-2"></i>';
            baseClass += ' bg-blue-100 text-blue-800 border border-blue-200';
        }
        messageArea.innerHTML = `<div class="${baseClass}">${icon} ${message}</div>`;
        lucide.createIcons();
    }

    // Function to render the credit report from the API data
    function renderReport(data) {
        // Access nested properties based on the expected successful response structure
        const score = data.creditScore;
        const metrics = getScoreMetrics(score);
        const evaluationDate = data.evaluationDate;
        const customer = data.customer;
        
        const scoreMeterElement = document.getElementById('scoreMeter');
        const scoreTextElement = scoreMeterElement.querySelector('.score-text');

        // Calculate percentage for gauge (Using 300 min, 850 max for visual scale)
        const SCORE_MIN = 300;
        const SCORE_MAX = 850;
        const scorePercent = Math.min(100, Math.max(0, (score - SCORE_MIN) / (SCORE_MAX - SCORE_MIN) * 100));

        // Apply styles to score meter
        scoreMeterElement.style.setProperty('--score-percent', `${scorePercent}%`);
        scoreMeterElement.style.setProperty('--score-color', metrics.color);
        scoreTextElement.textContent = score;
        scoreTextElement.style.color = metrics.color;

        // Update detailed display elements
        document.getElementById('displayScore').textContent = score;
        document.getElementById('displayScore').style.color = metrics.color;
        
        document.getElementById('scoreRating').textContent = metrics.rating;
        document.getElementById('scoreRating').className = metrics.colorClass + ' inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full';
        
        // Use provided data
        document.getElementById('displayDate').textContent = evaluationDate;
        
        // Update customer info in the navbar
        document.getElementById('customer-info').textContent = `${customer.name || 'Mock Customer'} (ID: ${customer.customerId})`;
        
        reportContainer.classList.remove('hidden');
    }

    // UPDATED: Core function to call the API with robust error handling
    async function evaluateCreditScore() {
        setLoading(true);
        reportContainer.classList.add('hidden'); // Hide old report on new evaluation attempt
        
        // Use the exact, non-mocked URL
        const url = `http://localhost:8082/evaluate`; 
        
        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            // Throw an error if the connection or HTTP status is not successful
            if (!response.ok) {
                // Attempt to parse JSON error message if available
                const errorResult = await response.json().catch(() => ({}));
                const statusText = errorResult.message || response.statusText || `HTTP Error ${response.status}`;
                throw new Error(statusText);
            }

            const result = await response.json();
            
            if (result.status === 'Success') {
                displayMessage('success', result.message);
                renderReport(result.data);
            } else {
                // Handle API error messages (e.g., status: "error")
                const errorMessage = result.message || 'An unknown error occurred during evaluation.';
                displayMessage('error', errorMessage);
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            // Display a user-friendly error message, especially for network failures
            displayMessage('error', `Evaluation failed. Please ensure the API server is running at ${url}. Error: ${error.message}`);
        } finally {
            setLoading(false);
            lucide.createIcons();
        }
    }

    function logout() {
        alert("Logging out (Session clearing logic is server-side).");
        // In a real application, this would redirect or clear local storage/cookies
    }

    // Initial setup on load
    window.onload = () => {
        document.getElementById('customer-info').textContent = `Customer ID: ${MOCK_CUSTOMER_ID} (Mock Session)`;
        displayMessage('info', 'Press the button to evaluate your latest Credit Score.');
        lucide.createIcons();
    };

    // Initialize icons
    lucide.createIcons();
</script>
</body>
</html>